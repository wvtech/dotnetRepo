@*@model TransitExec.Models.DriverList*@
@{
    ViewBag.Title = "Home Page";
}

<link href="css/bootstrap.css" rel="stylesheet">
<script src="~/Scripts/jquery-1.8.2.min.js"></script>
<script src="~/Contents/angular.min.js"></script>
<script src="~/Contents/CallingApi.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script src="http://maps.google.com/maps/api/js?sensor=true" type="text/javascript"></script>
<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
<script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.4.8/angular.min.js"></script>
@*<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.5.0/js/bootstrap-datepicker.js"></script>*@

<script src="//code.jquery.com/jquery-1.10.2.js"></script>
<script src="//code.jquery.com/ui/1.11.2/jquery-ui.js"></script>

<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
<link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.9/themes/base/jquery-ui.css" type="text/css" media="all" />
<script src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.5.min.js" type="text/javascript"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.devbridge-autocomplete/1.2.7/jquery.devbridge-autocomplete.min.js" type="text/javascript"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.9/jquery-ui.min.js" type="text/javascript"></script>


<script src="~/Scripts/app.js"></script>

<script>

    jQuery(function ($) {

        $("#txtSearch").autocomplete({
            source: function (request, response) {
               
                var autocompleteUrl = 'http://103.231.44.154:7879/api/website/Get_AllDrivers?term=' + request.term;
               
               $.ajax({
                    url: autocompleteUrl,
                    type: 'GET',
                    cache: false,
                    success: function (json) {
                        response($.map(json.data, function (data, id) {
                              return {
                                  label: data.DriverName,
                                    val: data.DriverId
                                };
                         
                           
                        }));

                    },
                    error: function (xmlHttpRequest, textStatus, errorThrown) {
                        alert("on error");
                        console.log('some error occured', textStatus, errorThrown);
                    }
                });
            },
            select: function (event, ui) {
                //alert(ui.item.val);
                var DriverId = ui.item.val;
                GetDriverDetails(DriverId);
                $('#lblUserId').val(ui.item.val);
            }
        });

    });
 
</script>

<!-- This css is to ensure that the google map contols (zoom bar etc) show and size correctly. -->
<style>
    #map_canvas img {
        max-width: none;
    }
</style>

<!-- This css is to give a nice big popup "info window" when a marker is clicked on the map -->
<style>
    .infoDiv {
        height: 200px;
        width: 300px;
        -webkit-user-select: none;
        background-color: white;
    }
    .changecolor {
       color:red;
    }
  
</style>

<div class="wrapper" ng-app="myapp" >
    <div class="container-fluid" id="mycontroller" ng-controller="mycontroller">
        <div class="row">
            <div class="col-md-3">

            </div>

           
            <div class="col-md-6 text-center">
                <img src="img/logo.png" style="width:26%; margin-left: 15%;" class="img-responsive">

            </div>
            <div class="col-md-3 text-center">
              
            </div>
        </div>
        <div classs="row clearfix">
            <div class="col-sm-9 text-center">
                <ul class="list-inline icons">
                    <li><img src="~/dots/on_road.png" class="leftGap"> Passenger on Board</li>
                    <li><img src="~/dots/empty.png" class="leftGap"> Empty Vehicle</li>
                    <li><img src="~/dots/idle.png" class="leftGap">  Over Speed</li>
                    <li><img src="~/dots/over_speed.png" class="leftGap">Idle Vehicle</li>
                    <li><img src="~/dots/on_break.png" class="leftGap"> On break</li>
                    <li><img src="~/dots/break_time.png" class="leftGap"> On break-exceeded time</li>
                </ul>
               
                <div id="map_canvas" style="height: 500px;width:100%; border:2px solid #2e6da4;"></div>
            </div>
            <!-- This is the div that will contain the Google Map -->
            <div class="col-sm-3">
                <input class="form-control border-2" type="text" id="datepicker" ng-model="date" placeholder="Search by date">
                <input type="hidden" ng-model="date" />
                <div id="DriverList" class="mmheight topGap-15">
                    <table id="tblDriverList" cellpadding="2" cellspacing="2" border="1" class="table table-hover" style="border:2px solid #2e6da4;">
                        <tr><th>Driver Name, Fleet No.</th> <th>Legs</th><th>Status</th></tr>
                        <tr ng-repeat="driver in data.data" ng-click="DriverInfoOnSelection(driver.DriverId)">
                            <td>{{driver.DriverName}},{{driver.VehicleNumber}}</td>
                            <td class='changecolor'>{{driver.Legs}}</td>

                            <td align='center' ng-if="driver.IsActive=='True'">

                                <img ng-src="{{driver.path}}" />

                            </td>
                            <td align='center' ng-if="driver.IsActive!='True'"></td>
                           
                        </tr>
                    </table>

                </div>
            </div>

        </div>
        <div class="row">

            <div class="col-sm-9">

                <div class="align-proper">

                   
                    <input type="hidden" id="TempID" />
                    <div id="appendd">

                        <table id="tblDriverDetails" cellpadding="2" cellspacing="2" border="1" class="table table-striped">
                            <tr>
                                <th>Status</th>
                                <th>PickUp Time</th>
                                <th>Appointment</th>
                                <th>Customer Name</th>
                                <th>Mobility</th>
                                <th>Vehicle</th>
                                <th>From</th>
                                <th>To</th>
                                <th>Distance</th>
                                <th>ETA</th>
                                <th>PickUp</th>
                                <th>DropOff</th>

                            </tr>
                            <tr ng-repeat="item in Data.data">
                                <td>{{item.Status}}</td>
                                <td>{{item.pickuptime}}</td>
                                <td>{{item.appointmenttime}}</td>
                                <td>{{item.CustomerName}}</td>
                                <td>{{item.Mobilty}}</td>
                                <td>{{item.VehicleNumber}}</td>
                                <td>{{item.fromaddress}}</td>
                                <td>{{item.toaddress}}</td>
                                <td>{{item.distance}}</td>
                                <td align='center'><img ng-src="dots/green.png" /></td>
                                <td align='center'><img ng-src="dots/green.png" /></td>
                                <td align='center'><img ng-src="dots/green.png" /></td>

                                

<tr></tr>
                        </table>
                    </div>
                </div>

            </div>
        </div>
    </div>
    <div class="topGap-15 padding-25" style="background-color:#ccc; color:#fff;"><p class="text-center"></p></div>
</div>

<script type="text/javascript">
    var map;
    var marker;
    var markers = [];
    
    function GetAllEmployees(status) {
        
        jQuery.support.cors = true;
        var settings = {
            "async": true,
            "crossDomain": true,
            //"url": "http://103.231.44.154:7879//api/VehicleList/Get_VehicleList",
            "url": "http://103.231.44.154:7879//api/VehicleList/Get_VehicleList",
            "method": "GET",
            "headers": {}
        }

        $.ajax(settings).done(function (data) {
          
            console.log(data);
            
            
            setTimeout(GetAllEmployees, 1000 * 4,1);
            for (var i = 0; i < markers.length; i++) {
                markers[i].setMap(null);
            }
            markers = [];
            var bounds = new google.maps.LatLngBounds();
            for (var item = 0; item < data.data.length; item++) {
                
                marker = new google.maps.Marker({
                    position: new google.maps.LatLng(data.data[item].LastLatitude, data.data[item].LastLongitude),
                    map: map,
                    title: data.data[item].VehicleName,
                    content: "<div class='infoDiv'><h2>" + data.data[item].VehicleName + "</h2>" + "<div><h4>Driver Name:" + data.data[item].DriverName + "</h4></div><div><h4>Vehicle Number:" + data.data[item].VehicleNumber + "</h4></div><div><h4>Vehicle Speed:" + data.data[item].Speed + " " + "Miles/Hour" + "</h4></div></div>"
                });
              
                markers.push(marker);
               
                if (data.data[item].Speed < 10) {
                    
                    marker.setIcon("dots/over_speed.png");
                }
               
                 if (data.data[item].PickUp == 1)
                {                                     
                                    
                    marker.setIcon("dots/on_road.png");
                 }
                 if (data.data[item].Speed > data.data[item].SpeedLimit) {
                     marker.setIcon("dots/idle.png");
                 }
                 if (data.data[item].PickUp == 1 && data.data[item].Speed > data.data[item].SpeedLimit) {

                     marker.setIcon("dots/on_road_speed.png");
                 }
                 if (data.data[item].Drop == 1)
                {
                    
                    marker.setIcon("dots/empty.png");
                 }
                 if (data.data[item].Drop == 1 && data.data[item].Speed > data.data[item].SpeedLimit) {

                     marker.setIcon("dots/empty_speed.png");
                 }
                
                 if (data.data[item].BreakTimeStatus == 1) {

                    marker.setIcon("dots/on_break.png");
                 }
                 if (data.data[item].BreakTimeStatus == 1 && data.data[item].Speed > data.data[item].SpeedLimit) {

                     marker.setIcon("dots/on_break_speed.png");
                 }
                 if (data.data[item].BreakTimeStatus == 2) {
               
                   
                    marker.setIcon("dots/break_time.png");
                 }
                 if (data.data[item].BreakTimeStatus == 2 && data.data[item].Speed > data.data[item].SpeedLimit) {


                     marker.setIcon("dots/break_time_speed.png");
                 }
                bounds.extend(marker.position);

                // finally hook up an "OnClick" listener to the map so it pops up out info-window when the marker-pin is clicked!
                google.maps.event.addListener(marker, 'click', function () {
                    var infowindow = new google.maps.InfoWindow();
                    infowindow.setContent(this.content);
                    infowindow.open(map, this);
                    
                });
                if(status==0)
                map.fitBounds(bounds);
               
            }
            
        });
    }

    $(document).ready(function () {
        Initialize(42.9116996610937, -87.8630463593526);
        GetAllEmployees(0);
       
    });

    // Where all the fun happens
    function Initialize(Lat,Long)
    {
       
        // Google has tweaked their interface somewhat - this tells the api to use that new UI
        google.maps.visualRefresh = true;
        var Liverpool = new google.maps.LatLng(Lat,Long);

        // These are options that set initial zoom level, where the map is centered globally to start, and the type of map to show
        var mapOptions = {
            zoom:10,
            center: Liverpool,
            mapTypeId: google.maps.MapTypeId.G_NORMAL_MAP

        };

        // This makes the div with id "map_canvas" a google map
        map = new google.maps.Map(document.getElementById("map_canvas"), mapOptions);
        

    }
    function SearchByVehicleNo(VehicleNumber) {
       
        jQuery.support.cors = true;
        var setting = {
            "async": true,
            "crossDomain": true,
            "url": "http://103.231.44.154:7879//api/VehicleList/Get_latLongByVehicleNo",
            "method": "GET",
            "headers": {},
            "data": { VehicleNo: VehicleNumber}
    }

        $.ajax(setting).done(function (data) {

            console.log(data);                  
            if (data.success != 0) {
                Initialize(data.data[0].LastLatitude, data.data[0].LastLongitude);
            }
            else {
                alert("Invalid Vehicle Number");
            }
        });
    }
    
  
    function GetDriverDetails(DriverId) {
       
        jQuery.support.cors = true;
        var setting = {
            "async": true,
            "crossDomain": true,
            "url": "http://103.231.44.154:7879//api/Website/Get_SearchDriverDetails",
            "method": "GET",
            "headers": {},
            "data": { DriverId: DriverId }
        }

        $.ajax(setting).done(function (data) {
           
            console.log(data);
           
                $("#tblDriverDetails tr").empty();
                var html = "<tr ><th>Status</th>   <th>PickUp Time</th>   <th>Appointment</th>  <th>Customer Name</th>  <th>Mobility</th>   <th>Vehicle</th> <th>From</th> <th>To</th>    <th>Distance</th>  <th>ETA</th>   <th>PickUp</th>   <th>DropOff</th></tr>";
                $("#tblDriverDetails tbody").append(html);
            if (data.success != 0) {
                for (var item = 0; item < data.data.length; item++) {
                    var html = "<tr id='tr'" + item + "><td>" + data.data[item].Status + "</td>";
                    html += "<td>" + data.data[item].pickuptime + "</td>";
                    html += "<td>" + data.data[item].appointmenttime + "</td>";
                    html += "<td>" + data.data[item].CustomerName + "</td>";
                    html += "<td>" + data.data[item].Mobilty + "</td>";
                    html += "<td>" + data.data[item].VehicleNumber + "</td>";
                    html += "<td>" + data.data[item].fromaddress + "</td>";
                    html += "<td>" + data.data[item].toaddress + "</td>";
                    html += "<td>" + data.data[item].distance + "</td>";

                    html += "<td align='center'><img src=" + "/dots/green.png" + "></td>";
                    html += "<td align='center'><img src=" + "/dots/green.png" + "></td>";
                    html += "<td align='center'><img src=" + "/dots/green.png" + "></td></tr>";
              
                    $("#tblDriverDetails tbody").append(html);
                   
                  
                  
                };
            }
            else {
                alert("No record found");
            }
        });
    }
    $("#btnSearch").click(function () {
        var VehicleNumber = $('#txtSearch').val();        
       
        SearchByVehicleNo(VehicleNumber);
    });
    
    $(function () {
        $("#datepicker").datepicker({ dateFormat: "mm/dd/yy" });

    });
    $("#datepicker").change(function () {
        var Date = $('#datepicker').val();
        var timeoutId = $("#TempID").val()
        clearTimeout(timeoutId);
        angular.element(document.getElementById('mycontroller')).scope().DriverCustomerInfoByDate();

  
    });
    function DriverList( Date) {      
        jQuery.support.cors = true;
        var setting = {
            "async": true,
            "crossDomain": true,
            "url": "http://103.231.44.154:7879//api/Website/Get_DriverSummaryByDate",
            "method": "GET",          
            "headers": {},
            "data": {Date:Date}

        }

        $.ajax(setting).done(function (data) {

            $("#tblDriverList tr").empty();
            var html = "<tr><th>Vehicle Number</th> <th>Driver Name</th>  <th>Legs</th></tr>";
            $("#tblDriverList tbody").append(html);

          
            console.log(data);            

            for (var item = 0; item < data.data.length; item++)
                {

                var html = "<tr><td>" + data.data[item].VehicleNumber + "</td>";
                html += "<td>" + data.data[item].DriverName + "</td>";
                html += "<td class='changecolor' >" + data.data[item].Legs + "</td></tr>";
                $("#tblDriverList").append(html);
                // the above line is like that because you use <tbody> 
                // in table definition.
                var opt = new Option(data.data[item].DriverName, data.data[item].DriverId);

                $('#myList').append(opt);
            };

        });
    }
   
</script>



